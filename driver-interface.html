<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="session-manager.js"></script>
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø³Ø¹Ø§Ù">
    
    <!-- Open Graph Meta Tags for WhatsApp, Email, etc -->
    <meta name="description" content="Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¥Ø³Ø¹Ø§Ù Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† - Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ© Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø¸ÙØ§Ø± - Ù…Ø±ÙƒØ² Ø­Ø§Ø³Ùƒ Ø§Ù„ØµØ­ÙŠ">
    <meta property="og:title" content="ØªØ³Ø¬ÙŠÙ„ Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø³Ø¹Ø§Ù - Ù…Ø±ÙƒØ² Ø­Ø§Ø³Ùƒ Ø§Ù„ØµØ­ÙŠ">
    <meta property="og:description" content="Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¥Ø³Ø¹Ø§Ù Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† - Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ© Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø¸ÙØ§Ø± - Ù…Ø±ÙƒØ² Ø­Ø§Ø³Ùƒ Ø§Ù„ØµØ­ÙŠ">
    <meta property="og:image" content="https://officerhasikhc-design.github.io/Register-ambulance-Transfer/moh-photo_Page_1.png">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_OM">
    <meta property="og:site_name" content="Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø³Ø¹Ø§Ù">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="moh-logo.png">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø³Ø¹Ø§Ù - Ø§Ù„Ø³Ø§Ø¦Ù‚</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #1e40af;
            --light-blue: #3b82f6;
            --lighter-blue: #eff6ff;
            --dark-blue: #1e3a8a;
            --bg-gradient: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #0ea5e9 100%);
            --white: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --error: #ef4444;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }

        .header {
            text-align: center;
            color: var(--white);
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }

        .logo {
            width: 70px;
            height: 70px;
            margin-bottom: 10px;
            background: white;
            border-radius: 50%;
            padding: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header h2 {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.9;
        }

        .main-card {
            background: var(--white);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 600px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .welcome-section h3 {
            color: var(--primary-blue);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .welcome-section p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .driver-select-section {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-family: inherit;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--white);
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
        }

        .form-group input[readonly] {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        .time-display {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            margin-bottom: 16px;
        }

        .current-time {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-blue);
            font-family: 'Cairo', monospace;
            direction: ltr;
        }

        .current-date {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .btn-hint {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        .btn {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-departure {
            background: #f0fdf4;
            color: #166534;
            border: 2px solid #86efac;
        }

        .btn-departure:hover:not(:disabled) {
            background: #dcfce7;
            border-color: #4ade80;
        }

        .btn-return {
            background: #eff6ff;
            color: #1e40af;
            border: 2px solid #93c5fd;
        }

        .btn-return:hover:not(:disabled) {
            background: #dbeafe;
            border-color: #60a5fa;
        }

        /* Subtle border glow for the currently active button */
        @keyframes active-glow {
            0%, 100% { 
                border-color: #86efac;
                box-shadow: 0 0 0 0 rgba(134, 239, 172, 0);
            }
            50% { 
                border-color: #4ade80;
                box-shadow: 0 0 0 3px rgba(134, 239, 172, 0.2);
            }
        }

        @keyframes active-glow-blue {
            0%, 100% { 
                border-color: #93c5fd;
                box-shadow: 0 0 0 0 rgba(147, 197, 253, 0);
            }
            50% { 
                border-color: #60a5fa;
                box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.25);
            }
        }

        .btn-departure.active-btn {
            animation: active-glow 2.5s ease-in-out infinite;
        }

        .btn-departure.active-btn:hover {
            animation: none;
        }
        
        .btn-return.pulse-attention {
            animation: active-glow-blue 2.5s ease-in-out infinite;
        }
        
        .btn-return.pulse-attention:hover {
            animation: none;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            animation: none !important;
        }

        .btn-icon {
            font-size: 22px;
        }

        .status-message {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-message #statusIcon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .status-message h4 {
            color: #0369a1;
            font-size: 16px;
            margin-bottom: 6px;
        }

        .status-message p {
            color: #64748b;
            font-size: 13px;
        }

        .status-message.ready {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .status-message.ready h4 {
            color: #15803d;
        }

        .status-message.pending {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .status-message.pending h4 {
            color: #92400e;
        }

        /* Combined Pending Trip Card */
        .pending-trip-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
        }
        
        .pending-trip-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .pending-title {
            font-size: 16px;
            font-weight: 700;
            color: #92400e;
        }
        
        .pending-reminder {
            color: #dc2626;
            font-size: 13px;
            font-weight: 600;
        }
        
        .pending-separator {
            color: #92400e;
            font-weight: 400;
        }
        
        .departure-label {
            font-size: 13px;
            font-weight: 600;
            color: #78350f;
            margin-bottom: 8px;
        }
        
        .pending-trip-details {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            gap: 24px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detail-icon {
            font-size: 14px;
            color: #9ca3af;
        }
        
        .detail-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            direction: ltr;
        }


        .trip-history {
            margin-top: 20px;
            border-top: 2px solid #e5e7eb;
            padding-top: 20px;
        }

        .trip-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .trip-history h4 {
            color: var(--primary-blue);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .month-filter {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            background: var(--white);
        }

        .trip-item {
            background: var(--lighter-blue);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .trip-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .trip-item-date {
            font-weight: 500;
            color: #6b7280;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .trip-id {
            font-weight: 700;
            color: var(--primary-blue);
            font-size: 14px;
            background: #e0e7ff;
            padding: 2px 8px;
            border-radius: 6px;
        }

        .trip-item-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-complete {
            background: var(--success-light);
            color: var(--success);
        }

        .status-pending {
            background: var(--warning-light);
            color: #92400e;
        }
        
        .status-approved {
            background: #dcfce7;
            color: #166534;
        }
        
        .trip-approved {
            border-right: 4px solid #22c55e;
        }

        .trip-item-times {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .time-row {
            display: flex;
            gap: 8px;
        }
        
        .time-label {
            color: #6b7280;
        }
        
        .time-value {
            font-weight: 600;
            color: #1f2937;
            direction: ltr;
        }

        .success-message {
            display: none;
            background: var(--success-light);
            border: 2px solid var(--success);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
            animation: slideIn 0.3s ease;
        }

        .success-message.show {
            display: block;
        }

        .success-message .icon {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .success-message h4 {
            color: var(--success);
            font-size: 16px;
            margin-bottom: 4px;
        }

        .success-message p {
            color: #065f46;
            font-size: 13px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .empty-state {
            text-align: center;
            padding: 24px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 40px;
            opacity: 0.3;
            margin-bottom: 8px;
        }

        .blocked-message {
            background: #fee2e2;
            border: 2px solid var(--error);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .blocked-message h4 {
            color: var(--error);
            font-size: 15px;
            margin-bottom: 6px;
        }

        .blocked-message p {
            color: #991b1b;
            font-size: 13px;
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .main-card {
                padding: 18px;
                border-radius: 16px;
            }

            .current-time {
                font-size: 24px;
            }

            .btn {
                padding: 16px 20px;
                font-size: 16px;
            }

            .btn-icon {
                font-size: 20px;
            }
        }
        /* Connection Status Indicator */
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 8px 16px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s;
            display: none;
        }

        .connection-status.offline {
            display: block;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .connection-status.syncing {
            display: block;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .connection-status.synced {
            display: block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            animation: fadeOut 3s forwards;
        }

        @keyframes fadeOut {
            0%, 70% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }

        .offline-badge {
            display: inline-block;
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }

        body.offline-mode .main-card {
            border: 2px solid #f59e0b;
        }
    </style>
</head>
<body>
    <!-- Connection Status Bar -->
    <div class="connection-status" id="connectionStatus">
        <span id="connectionText"></span>
    </div>

    <div class="header">
        <img src="moh-logo.png" alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©" class="logo">
        <h1>Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ© Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø¸ÙØ§Ø±</h1>
        <h2>ÙˆÙ„Ø§ÙŠØ© Ø³Ø¯Ø­ - Ù…Ø±ÙƒØ² Ø­Ø§Ø³Ùƒ Ø§Ù„ØµØ­ÙŠ</h2>
    </div>

    <div class="main-card">
        <div class="welcome-section">
            <h3>ØªØ³Ø¬ÙŠÙ„ Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø³Ø¹Ø§Ù</h3>
            <p>Ø³Ø¬Ù‘Ù„ ÙˆÙ‚Øª Ø§Ù„Ø°Ù‡Ø§Ø¨ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ø¨Ø¶ØºØ·Ø© Ø²Ø±</p>
            <div class="offline-badge" id="offlineBadge" style="display: none;">
                âš ï¸ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ - Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
            </div>
        </div>

        <!-- Driver Info (when logged in) -->
        <div class="driver-info-section" id="driverInfoSection" style="display: none;">
            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; position: relative;">
                <div style="text-align: right;">
                    <div style="font-size: 12px; color: #9ca3af; margin-bottom: 2px;">Ù…Ø±Ø­Ø¨Ø§Ù‹</div>
                    <div style="font-size: 15px; font-weight: 600; color: #374151;" id="loggedInDriverName"></div>
                    <div style="font-size: 12px; color: #9ca3af; margin-top: 2px;"><span id="staffNumberLabel">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</span>: <span id="loggedInStaffNumber" style="direction: ltr;"></span></div>
                </div>
                <button onclick="logout()" style="background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; white-space: nowrap;">
                    Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>

        <!-- Driver Selection (when not logged in or admin) -->
        <div class="driver-select-section" id="driverSelection">
            <div class="form-group">
                <label>Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ</label>
                <select id="driverName" onchange="selectDriver()">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ / Ø§Ù„Ù…Ø¯Ù†ÙŠ</label>
                <input type="text" id="staffNumber" readonly placeholder="ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
            </div>
        </div>

        <!-- Pending Trip Alert - Combined single card (ABOVE time display) -->
        <div class="pending-trip-card" id="pendingTrip" style="display: none;">
            <div class="pending-trip-header">
                <span class="pending-title">Ø±Ø­Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>
                <span class="pending-separator">-</span>
                <span class="pending-reminder">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹ÙˆØ¯Ø©</span>
            </div>
            <div class="departure-label">Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ø­Ù„Ø© Ø§Ù„Ø°Ù‡Ø§Ø¨</div>
            <div class="pending-trip-details">
                <div class="detail-item">
                    <span class="detail-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                    <span class="detail-value" id="pendingDate">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Ø§Ù„ÙˆÙ‚Øª:</span>
                    <span class="detail-value" id="pendingTime">-</span>
                </div>
            </div>
        </div>

        <!-- Current Time Display -->
        <div class="time-display">
            <div class="current-time" id="currentTime">00:00:00</div>
            <div class="current-date" id="currentDate"></div>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            <div class="icon">âœ…</div>
            <h4 id="successTitle">ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­</h4>
            <p id="successText"></p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" id="actionButtons" style="display: none;">
            <div class="btn-wrapper" id="departureWrapper">
                <div class="btn-hint" id="departureHint">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø§Ø¨</div>
                <button class="btn btn-departure active-btn" id="btnDeparture" onclick="recordDeparture()">
                    <span>â†’ ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø°Ù‡Ø§Ø¨</span>
                </button>
            </div>
            <div class="btn-wrapper" id="returnWrapper">
                <div class="btn-hint" id="returnHint" style="display: none;">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹ÙˆØ¯Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØµÙˆÙ„</div>
                <button class="btn btn-return" id="btnReturn" onclick="recordReturn()" disabled>
                    <span>â† ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø¹ÙˆØ¯Ø©</span>
                </button>
            </div>
        </div>

        <!-- Trip History -->
        <div class="trip-history">
            <div class="trip-history-header">
                <h4>Ø³Ø¬Ù„ Ø±Ø­Ù„Ø§ØªÙŠ</h4>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span id="currentMonthBadge" style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;"></span>
                    <select class="month-filter" id="monthFilter" onchange="loadTripHistory()">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
            </div>
            <div id="tripHistory">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwDUAGlnGBKZMhq8UbzEYBUaP3UNi49Be5PdwqQfnyIiB1HomgXVLrmUTrgeLKhyb-j/exec';

        // ============================================
        // DRIVERS DATA
        // ============================================
        const DEFAULT_DRIVERS = [
            { nameAr: 'Ø³Ø¹Ø¯ Ø²Ø§ÙŠØ¯ Ø§Ù„Ø¬Ù†ÙŠØ¨ÙŠ', nameEn: 'SAAD ZAID AL-JUNAIBI', staffNumber: '39121', type: 'employee' },
            { nameAr: 'Ø­Ø³Ø§Ù† Ø«Ø§Ø¨Øª Ø±Ø¬Ø¨', nameEn: 'HASSAN THABIT RAJAB', staffNumber: '222975657', type: 'daily-paid' },
            { nameAr: 'Ù…Ø­Ù…Ø¯ Ø§Ù„Ø±Ø¶Ù‡ Ø¹Ù„ÙŠ', nameEn: 'MOHAMMED AL-RUDHA ALI', staffNumber: '39634', type: 'employee' },
            { nameAr: 'Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ù…Ø³Ù„Ù… Ø§Ù„Ù†Ù‚Ø´', nameEn: 'ABDULAZIZ MUSALLEM AL-NAQSH', staffNumber: '65870', type: 'employee' }
        ];

        const DRIVERS_DATA = JSON.parse(localStorage.getItem('ambulance_drivers')) || DEFAULT_DRIVERS;

        // ============================================
        // STATE
        // ============================================
        let selectedDriver = null;
        let pendingTrip = null;
        let driverHistoryPage = 1;
        const DRIVER_TRIPS_PER_PAGE = 5;
        let allDriverHistory = [];

        // ============================================
        // INITIALIZE
        // ============================================
        function init() {
            initializeDriverDropdown();
            initializeMonthFilter();
            updateClock();
            setInterval(updateClock, 1000);
            
            // Load user session and auto-select driver
            loadUserSession();
            
            // Request notification permission
            requestNotificationPermission();
        }

        // Initialize month filter with current month selected
        function initializeMonthFilter() {
            const monthNames = [
                'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            ];
            
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentYear = now.getFullYear();
            
            const select = document.getElementById('monthFilter');
            const badge = document.getElementById('currentMonthBadge');
            
            // Set current month badge
            badge.textContent = `${monthNames[currentMonth - 1]} ${currentYear}`;
            
            // Build options
            let options = `<option value="${currentMonth}">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (${monthNames[currentMonth - 1]})</option>`;
            options += '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±</option>';
            
            // Add all months
            for (let i = 1; i <= 12; i++) {
                if (i !== currentMonth) {
                    options += `<option value="${i}">${monthNames[i - 1]}</option>`;
                }
            }
            
            select.innerHTML = options;
        }

        // Load user session from login
        function loadUserSession() {
            const session = localStorage.getItem('userSession');
            if (session) {
                try {
                    const userData = JSON.parse(session);
                    
                    // Check if user is admin with driver access
                    if (userData.type === 'admin' && userData.canAccessDriver) {
                        // Admin can select any driver - show dropdown
                        document.getElementById('driverSelection').style.display = 'block';
                        document.getElementById('driverInfoSection').style.display = 'none';
                        window.loggedInUser = userData;
                        return;
                    }
                    
                    if (userData.type === 'driver') {
                        // Determine employee type from session or DRIVERS_DATA
                        let empType = userData.employeeType || 'employee';
                        const matchedDriver = DRIVERS_DATA.find(d => d.staffNumber === userData.staffNumber);
                        if (matchedDriver) {
                            empType = matchedDriver.type || empType;
                        }
                        
                        // Hide dropdown and show driver info
                        document.getElementById('driverSelection').style.display = 'none';
                        document.getElementById('driverInfoSection').style.display = 'block';
                        document.getElementById('loggedInDriverName').textContent = userData.nameAr;
                        document.getElementById('loggedInStaffNumber').textContent = userData.staffNumber;
                        document.getElementById('staffNumberLabel').textContent = empType === 'daily-paid' ? 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ' : 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ';
                        
                        // Set selected driver from session
                        selectedDriver = {
                            nameAr: userData.nameAr,
                            nameEn: userData.nameEn,
                            staffNumber: userData.staffNumber,
                            type: empType
                        };
                        
                        document.getElementById('staffNumber').value = userData.staffNumber;
                        document.getElementById('actionButtons').style.display = 'flex';
                        
                        // Load pending trip and history
                        loadPendingTrip();
                        loadTripHistory();
                        updateButtons();
                        
                        window.loggedInUser = userData;
                        return;
                    }
                    
                } catch (e) {
                    console.log('No valid session found');
                }
            }
        }

        // Logout function - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        function logout() {
            showLogoutConfirm();
        }

        function showLogoutConfirm() {
            // Create custom confirm dialog
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                font-family: inherit;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 16px;
                max-width: 280px;
                width: 90%;
                text-align: center;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            `;

            content.innerHTML = `
                <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
                <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 13px;">Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="cancelLogout()" style="padding: 6px 16px; border: 1px solid #d1d5db; background: white; color: #6b7280; border-radius: 6px; font-size: 13px; cursor: pointer; font-family: inherit;">Ø¥Ù„ØºØ§Ø¡</button>
                    <button onclick="confirmLogout()" style="padding: 6px 16px; border: none; background: #ef4444; color: white; border-radius: 6px; font-size: 13px; cursor: pointer; font-family: inherit;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            `;

            dialog.appendChild(content);
            document.body.appendChild(dialog);

            // Store reference to dialog
            window.logoutDialog = dialog;
        }

        function cancelLogout() {
            if (window.logoutDialog) {
                document.body.removeChild(window.logoutDialog);
                window.logoutDialog = null;
            }
        }

        function confirmLogout() {
            cancelLogout();
            // Clear session
            localStorage.removeItem('userSession');
            localStorage.removeItem('selected_driver');
                
            // Redirect to login page
            window.location.href = 'login.html';
        }

        function initializeDriverDropdown() {
            const select = document.getElementById('driverName');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ --</option>';
            
            DRIVERS_DATA.forEach((driver, index) => {
                select.innerHTML += `<option value="${index}">${driver.nameAr}</option>`;
            });
        }

        function selectDriver() {
            const select = document.getElementById('driverName');
            const staffInput = document.getElementById('staffNumber');
            const index = select.value;
            const actionButtons = document.getElementById('actionButtons');
            const pendingDiv = document.getElementById('pendingTrip');

            if (index !== '') {
                selectedDriver = DRIVERS_DATA[index];
                staffInput.value = selectedDriver.staffNumber;
                localStorage.setItem('selected_driver', index);
                
                // Style for daily-paid
                if (selectedDriver.type === 'daily-paid') {
                    staffInput.style.background = '#fef3c7';
                } else {
                    staffInput.style.background = '#f3f4f6';
                }

                // Show action buttons
                actionButtons.style.display = 'flex';

                // Load pending trip for this driver
                loadPendingTrip();
                loadTripHistory();
            } else {
                selectedDriver = null;
                staffInput.value = '';
                staffInput.style.background = '#f3f4f6';
                
                // Hide action buttons and pending trip
                actionButtons.style.display = 'none';
                pendingDiv.style.display = 'none';
            }

            updateButtons();
        }

        // ============================================
        // CLOCK
        // ============================================
        function updateClock() {
            const now = new Date();
            
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'Ù…' : 'Øµ';
            hours = hours % 12 || 12;
            
            document.getElementById('currentTime').textContent = 
                `${hours}:${minutes}:${seconds} ${ampm}`;

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('ar-SA', options);
        }

        // ============================================
        // TRIP MANAGEMENT
        // ============================================
        async function loadPendingTrip() {
            if (!selectedDriver) return;

            const pendingDiv = document.getElementById('pendingTrip');
            const key = `pending_trip_${selectedDriver.staffNumber}`;
            
            // First try to get from server (most reliable source)
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getPendingTrips`);
                const result = await response.json();
                
                if (result.success && result.trips) {
                    // Check if there's a pending trip for this driver
                    const serverTrip = result.trips.find(t => 
                        t.staffNumber && t.staffNumber.toString() === selectedDriver.staffNumber.toString() && 
                        t.status === 'pending'
                    );
                    
                    if (serverTrip) {
                        // There's a pending trip on server - use it
                        pendingTrip = {
                            ...serverTrip,
                            departureDate: serverTrip.departureDate,
                            departureTime: serverTrip.departureTime
                        };
                        localStorage.setItem(key, JSON.stringify(pendingTrip));
                        console.log('Loaded pending trip from server:', pendingTrip);
                    } else {
                        // Check if trip was completed (status = 'complete' or 'submitted')
                        const completedTrip = result.trips.find(t => 
                            t.staffNumber && t.staffNumber.toString() === selectedDriver.staffNumber.toString() && 
                            (t.status === 'complete' || t.status === 'submitted')
                        );
                        
                        if (completedTrip) {
                            // Trip was completed, clear local storage
                            localStorage.removeItem(key);
                            pendingTrip = null;
                        } else {
                            // No trip on server, check localStorage
                            const localTrip = JSON.parse(localStorage.getItem(key));
                            if (localTrip && localTrip.status !== 'complete') {
                                pendingTrip = localTrip;
                            } else {
                                pendingTrip = null;
                            }
                        }
                    }
                }
            } catch (error) {
                console.log('Server unavailable, using local data:', error);
                // Fallback to localStorage
                const localTrip = JSON.parse(localStorage.getItem(key));
                if (localTrip && localTrip.status !== 'complete') {
                    pendingTrip = localTrip;
                } else {
                    pendingTrip = null;
                }
            }

            // Update UI based on pending trip status
            if (pendingTrip && pendingTrip.status !== 'complete' && pendingTrip.status !== 'submitted') {
                // Has pending trip - needs to record return
                pendingDiv.style.display = 'block';
                document.getElementById('pendingDate').textContent = pendingTrip.departureDate || '-';
                document.getElementById('pendingTime').textContent = pendingTrip.departureTime || '-';
            } else {
                // No pending trip - ready for new trip
                pendingDiv.style.display = 'none';
                pendingTrip = null;
                localStorage.removeItem(key);
            }

            updateButtons();
        }

        function updateButtons() {
            const btnDeparture = document.getElementById('btnDeparture');
            const btnReturn = document.getElementById('btnReturn');
            const departureHint = document.getElementById('departureHint');
            const returnHint = document.getElementById('returnHint');

            if (!selectedDriver) {
                btnDeparture.disabled = true;
                btnReturn.disabled = true;
                btnDeparture.classList.remove('active-btn');
                btnReturn.classList.remove('pulse-attention');
                departureHint.style.display = 'none';
                returnHint.style.display = 'none';
                return;
            }

            if (pendingTrip) {
                btnDeparture.disabled = true;
                btnDeparture.classList.remove('active-btn');
                btnReturn.disabled = false;
                btnReturn.classList.add('pulse-attention');
                departureHint.style.display = 'none';
                returnHint.style.display = 'block';
            } else {
                btnDeparture.disabled = false;
                btnDeparture.classList.add('active-btn');
                btnReturn.disabled = true;
                btnReturn.classList.remove('pulse-attention');
                departureHint.style.display = 'block';
                returnHint.style.display = 'none';
            }
        }

        async function recordDeparture() {
            if (!selectedDriver) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            if (pendingTrip) {
                alert('ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°. ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            // Disable button during submission
            const btn = document.getElementById('btnDeparture');
            btn.disabled = true;
            btn.innerHTML = '<span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</span>';

            const now = new Date();
            const date = now.toISOString().split('T')[0];
            
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12;
            const time = `${hours}:${minutes} ${ampm}`;

            const tripData = {
                action: 'driverDeparture',
                driverName: selectedDriver.nameEn,
                driverNameAr: selectedDriver.nameAr,
                staffNumber: selectedDriver.staffNumber,
                departureDate: date,
                departureTime: time
            };

            // Save locally first (always)
            pendingTrip = {
                ...tripData,
                departureTimestamp: now.getTime(),
                offlineSaved: !isOnline
            };
            const key = `pending_trip_${selectedDriver.staffNumber}`;
            localStorage.setItem(key, JSON.stringify(pendingTrip));

            if (isOnline) {
                try {
                    await fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(tripData)
                    });
                    showSuccess('ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø°Ù‡Ø§Ø¨', `${date} - ${time}`);
                } catch (error) {
                    console.error('Fetch failed, saving offline:', error);
                    queueOfflineData(tripData);
                    showSuccess('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹', `${date} - ${time}\nØ³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª`);
                }
            } else {
                // Offline - queue for later
                queueOfflineData(tripData);
                showSuccess('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹', `${date} - ${time}\nâš ï¸ Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª`);
            }

            // Update UI immediately
            updateButtons();
            
            // Show pending trip info
            const pendingDiv = document.getElementById('pendingTrip');
            pendingDiv.style.display = 'block';
            document.getElementById('pendingDate').textContent = date;
            document.getElementById('pendingTime').textContent = time;
            
            // Reset button text
            btn.innerHTML = '<span>â†’ ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø°Ù‡Ø§Ø¨</span>';
        }

        async function recordReturn() {
            if (!selectedDriver || !pendingTrip) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°');
                return;
            }

            // Disable button during submission
            const btn = document.getElementById('btnReturn');
            btn.disabled = true;
            btn.innerHTML = '<span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</span>';

            const now = new Date();
            const date = now.toISOString().split('T')[0];
            
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12;
            const time = `${hours}:${minutes} ${ampm}`;

            const returnData = {
                action: 'driverReturn',
                staffNumber: selectedDriver.staffNumber,
                returnDate: date,
                returnTime: time
            };

            // Complete the trip locally first (always)
            pendingTrip.returnDate = date;
            pendingTrip.returnTime = time;
            pendingTrip.returnTimestamp = now.getTime();
            pendingTrip.status = 'complete';

            // Save to history
            saveTripToHistory(pendingTrip);
            
            // Update pending_trips_for_nurse in localStorage
            updatePendingTripForNurseWithReturn(selectedDriver.staffNumber, date, time);

            // Clear pending
            const key = `pending_trip_${selectedDriver.staffNumber}`;
            localStorage.removeItem(key);
            pendingTrip = null;

            if (isOnline) {
                try {
                    await fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(returnData)
                    });
                    showSuccessAndReload('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'Ø§Ù„Ø±Ø­Ù„Ø© Ù…ÙƒØªÙ…Ù„Ø© - Ø¬Ø§Ù‡Ø² Ù„ØªØ³Ø¬ÙŠÙ„ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©');
                } catch (error) {
                    console.error('Fetch failed, saving offline:', error);
                    queueOfflineData(returnData);
                    showSuccessAndReload('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹', 'Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
                }
            } else {
                // Offline - queue for later
                queueOfflineData(returnData);
                showSuccessAndReload('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹', 'âš ï¸ Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
            }
        }
        
        // Update the pending trip for nurse with return data
        function updatePendingTripForNurseWithReturn(staffNumber, returnDate, returnTime) {
            let pendingTrips = JSON.parse(localStorage.getItem('pending_trips_for_nurse')) || [];
            
            // Find and update the trip for this driver
            pendingTrips = pendingTrips.map(trip => {
                if (trip.staffNumber === staffNumber && trip.status === 'pending') {
                    console.log('ğŸš— [DRIVER] Updating local trip for nurse:', trip.driverName);
                    return {
                        ...trip,
                        returnDate: returnDate,
                        returnTime: returnTime,
                        status: 'complete'
                    };
                }
                return trip;
            });
            
            localStorage.setItem('pending_trips_for_nurse', JSON.stringify(pendingTrips));
            console.log('ğŸš— [DRIVER] Updated pending_trips_for_nurse in localStorage');
        }

        function savePendingTripForNurse(trip) {
            let pendingTrips = JSON.parse(localStorage.getItem('pending_trips_for_nurse')) || [];
            
            // Remove old entry for same driver if exists
            pendingTrips = pendingTrips.filter(t => t.staffNumber !== trip.staffNumber);
            
            // Add new entry
            pendingTrips.push(trip);
            
            localStorage.setItem('pending_trips_for_nurse', JSON.stringify(pendingTrips));
        }

        function saveTripToHistory(trip) {
            const key = `trip_history_${selectedDriver.staffNumber}`;
            let history = JSON.parse(localStorage.getItem(key)) || [];
            history.unshift(trip);
            
            // Keep only last 100 trips
            if (history.length > 100) {
                history = history.slice(0, 100);
            }
            
            localStorage.setItem(key, JSON.stringify(history));
        }

        // Cache for server data
        let cachedServerTrips = null;
        let isLoadingHistory = false;
        
        async function loadTripHistory(showLoading = true) {
            const container = document.getElementById('tripHistory');
            const monthFilter = document.getElementById('monthFilter').value;
            
            if (!selectedDriver) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¤</div>
                        <p>Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø±Ø­Ù„Ø§ØªÙƒ</p>
                    </div>
                `;
                return;
            }

            // Show loading only on first load
            if (showLoading && !cachedServerTrips) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">...</div>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>
                    </div>
                `;
            }
            
            // Prevent multiple simultaneous loads
            if (isLoadingHistory) return;
            isLoadingHistory = true;

            let history = [];
            
            // Try to fetch from server
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getPendingTrips`);
                const result = await response.json();
                
                if (result.success && result.trips) {
                    cachedServerTrips = result.trips;
                    // Filter trips for this driver
                    history = result.trips.filter(t => 
                        t.staffNumber === selectedDriver.staffNumber
                    ).map(trip => ({
                        ...trip,
                        approved: trip.status === 'submitted'
                    }));
                }
            } catch (error) {
                // Use cached data if available
                if (cachedServerTrips) {
                    history = cachedServerTrips.filter(t => 
                        t.staffNumber === selectedDriver.staffNumber
                    ).map(trip => ({
                        ...trip,
                        approved: trip.status === 'submitted'
                    }));
                }
            }
            
            isLoadingHistory = false;
            
            // Also get local history and merge
            const key = `trip_history_${selectedDriver.staffNumber}`;
            const localHistory = JSON.parse(localStorage.getItem(key)) || [];
            
            // Merge: add local trips that aren't in server data
            localHistory.forEach(localTrip => {
                const exists = history.some(t => 
                    t.departureDate === localTrip.departureDate && 
                    t.departureTime === localTrip.departureTime
                );
                if (!exists) {
                    history.push(localTrip);
                }
            });
            
            // Sort by date (newest first)
            history.sort((a, b) => new Date(b.departureDate) - new Date(a.departureDate));

            // Filter by month if selected
            if (monthFilter !== 'all') {
                history = history.filter(trip => {
                    const tripMonth = new Date(trip.departureDate).getMonth() + 1;
                    return tripMonth === parseInt(monthFilter);
                });
            }

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>${monthFilter === 'all' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±'}</p>
                    </div>
                `;
                return;
            }

            allDriverHistory = history;
            driverHistoryPage = 1;
            renderDriverHistoryPage();
        }

        function renderDriverHistoryPage() {
            const container = document.getElementById('tripHistory');
            const totalPages = Math.ceil(allDriverHistory.length / DRIVER_TRIPS_PER_PAGE);
            const startIndex = (driverHistoryPage - 1) * DRIVER_TRIPS_PER_PAGE;
            const pageTrips = allDriverHistory.slice(startIndex, startIndex + DRIVER_TRIPS_PER_PAGE);

            let html = pageTrips.map(trip => {
                const isComplete = trip.status === 'complete' || trip.status === 'submitted';
                const isApproved = trip.status === 'submitted';
                
                let statusText = 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°';
                let statusClass = 'status-pending';
                
                if (isApproved) {
                    statusText = 'âœ… ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯';
                    statusClass = 'status-approved';
                } else if (isComplete) {
                    statusText = 'Ù…ÙƒØªÙ…Ù„Ø© - Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯';
                    statusClass = 'status-complete';
                }
                
                const tripId = trip.tripId || '-';
                
                return `
                    <div class="trip-item ${isApproved ? 'trip-approved' : ''}">
                        <div class="trip-item-header">
                            <span class="trip-id">${tripId}</span>
                            <span class="trip-item-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="trip-item-date">${trip.departureDate}</div>
                        <div class="trip-item-times">
                            <div class="time-row">
                                <span class="time-label">Ø§Ù„Ø°Ù‡Ø§Ø¨:</span>
                                <span class="time-value">${trip.departureTime || '-'}</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">Ø§Ù„Ø¹ÙˆØ¯Ø©:</span>
                                <span class="time-value">${trip.returnTime || '-'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Pagination controls
            if (totalPages > 1) {
                html += `
                    <div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:12px;padding:8px;">
                        <button onclick="changeDriverHistoryPage(-1)" ${driverHistoryPage <= 1 ? 'disabled' : ''} style="padding:6px 14px;border:1px solid #d1d5db;border-radius:8px;background:${driverHistoryPage <= 1 ? '#f3f4f6' : '#fff'};color:${driverHistoryPage <= 1 ? '#9ca3af' : '#1e40af'};cursor:${driverHistoryPage <= 1 ? 'default' : 'pointer'};font-size:13px;font-weight:600;">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                        <span style="font-size:13px;color:#6b7280;">ØµÙØ­Ø© ${driverHistoryPage} Ù…Ù† ${totalPages}</span>
                        <button onclick="changeDriverHistoryPage(1)" ${driverHistoryPage >= totalPages ? 'disabled' : ''} style="padding:6px 14px;border:1px solid #d1d5db;border-radius:8px;background:${driverHistoryPage >= totalPages ? '#f3f4f6' : '#fff'};color:${driverHistoryPage >= totalPages ? '#9ca3af' : '#1e40af'};cursor:${driverHistoryPage >= totalPages ? 'default' : 'pointer'};font-size:13px;font-weight:600;">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function changeDriverHistoryPage(delta) {
            const totalPages = Math.ceil(allDriverHistory.length / DRIVER_TRIPS_PER_PAGE);
            const newPage = driverHistoryPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                driverHistoryPage = newPage;
                renderDriverHistoryPage();
            }
        }

        function showSuccess(title, text) {
            const msg = document.getElementById('successMessage');
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successText').textContent = text;
            msg.classList.add('show');

            setTimeout(() => {
                msg.classList.remove('show');
            }, 3000);
        }

        function showSuccessAndReload(title, text) {
            const msg = document.getElementById('successMessage');
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successText').textContent = text;
            msg.classList.add('show');

            // Vibrate if supported
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }

            // Hide success message after 3 seconds
            setTimeout(() => {
                msg.classList.remove('show');
            }, 3000);
            
            // Update UI immediately without full reload
            loadPendingTrip();
            loadTripHistory();
            
            // Reset buttons
            document.getElementById('btnDeparture').disabled = false;
            document.getElementById('btnDeparture').innerHTML = '<span>â†’ ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø°Ù‡Ø§Ø¨</span>';
            document.getElementById('btnReturn').disabled = true;
            document.getElementById('btnReturn').innerHTML = '<span>â† ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø¹ÙˆØ¯Ø©</span>';
            document.getElementById('btnReturn').classList.remove('pulse-attention');
            updateButtons();
            
            // Reload page after 2 minutes to reset to default state
            setTimeout(() => {
                location.reload();
            }, 120000);
        }

        // ============================================
        // NOTIFICATIONS
        // ============================================
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }


        // ============================================
        // AUTO-REFRESH FOR REAL-TIME UPDATES
        // ============================================
        let lastHistoryHash = '';
        
        async function autoRefreshHistory() {
            if (!selectedDriver) return;
            
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getPendingTrips`);
                const result = await response.json();
                
                if (result.success && result.trips) {
                    // Update cache
                    cachedServerTrips = result.trips;
                    
                    // Filter trips for this driver
                    const driverTrips = result.trips.filter(t => 
                        t.staffNumber === selectedDriver.staffNumber
                    );
                    
                    // Create hash to detect changes
                    const newHash = JSON.stringify(driverTrips.map(t => ({
                        id: t.tripId,
                        status: t.status
                    })));
                    
                    if (newHash !== lastHistoryHash) {
                        lastHistoryHash = newHash;
                        // Silent update without loading indicator
                        loadTripHistory(false);
                        loadPendingTrip();
                    }
                }
            } catch (error) {
                // Silent fail
            }
        }
        
        // Check for updates every 10 seconds
        setInterval(autoRefreshHistory, 10000);

        // ============================================
        // OFFLINE SUPPORT | Ø¯Ø¹Ù… Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
        // ============================================
        let isOnline = navigator.onLine;
        const OFFLINE_QUEUE_KEY = 'offline_trip_queue';

        // Monitor connection status
        function updateConnectionStatus() {
            const statusBar = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            const offlineBadge = document.getElementById('offlineBadge');
            
            if (navigator.onLine) {
                isOnline = true;
                document.body.classList.remove('offline-mode');
                offlineBadge.style.display = 'none';
                
                // Check if we have queued data to sync
                const queue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
                if (queue.length > 0) {
                    statusBar.className = 'connection-status syncing';
                    statusText.textContent = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...';
                    syncOfflineQueue();
                } else {
                    statusBar.className = 'connection-status';
                }
            } else {
                isOnline = false;
                document.body.classList.add('offline-mode');
                offlineBadge.style.display = 'inline-block';
                statusBar.className = 'connection-status offline';
                statusText.textContent = 'âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹';
            }
        }

        // Queue data for offline sync
        function queueOfflineData(data) {
            const queue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
            queue.push({
                ...data,
                queuedAt: new Date().toISOString()
            });
            localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));
        }

        // Sync offline queue when back online
        async function syncOfflineQueue() {
            const queue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
            if (queue.length === 0) return;

            const statusBar = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            let successCount = 0;
            const newQueue = [];

            for (const item of queue) {
                try {
                    await fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(item)
                    });
                    successCount++;
                } catch (error) {
                    // Keep failed items in queue
                    newQueue.push(item);
                }
            }

            localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(newQueue));

            if (successCount > 0) {
                statusBar.className = 'connection-status synced';
                statusText.textContent = `âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${successCount} Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­`;
                
                // Refresh data
                setTimeout(() => {
                    loadPendingTrip();
                    loadTripHistory();
                }, 1000);
            }

            if (newQueue.length > 0) {
                setTimeout(syncOfflineQueue, 30000); // Retry in 30 seconds
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', () => {
            updateConnectionStatus();
        });

        window.addEventListener('offline', () => {
            updateConnectionStatus();
        });

        // Listen for sync messages from Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'SYNC_SUCCESS') {
                    const statusBar = document.getElementById('connectionStatus');
                    const statusText = document.getElementById('connectionText');
                    statusBar.className = 'connection-status synced';
                    statusText.textContent = 'âœ… ' + event.data.message;
                    loadPendingTrip();
                    loadTripHistory();
                }
            });
        }

        // ============================================
        // PWA
        // ============================================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => {
                    console.log('Service Worker registered');
                    // Request background sync
                    if ('sync' in reg) {
                        reg.sync.register('sync-offline-data');
                    }
                })
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        // Initialize connection status on load
        updateConnectionStatus();

        // Initialize on load
        init();
    </script>
</body>
</html>
